# 系统功能总览

本说明梳理医疗诊所管理系统的所有核心功能，并标注对应代码目录、服务层实现与数据存储位置，便于开发与交付时快速定位。

## 0. 系统入口与架构骨架

- **启动入口**：`src/clinic/ClinicApp.java` 负责初始化 `AppContext`、执行基础数据播种并展示登录窗口；`clinic.ClinicApp` 是打包运行时的主类。
- **上下文容器**：`src/clinic/AppContext.java` 注册全部仓库与服务实例，通过依赖注入方式向 UI 层提供统一访问。
- **领域模型**：`src/clinic/model/` 定义患者、医生、预约、财务等数据结构，CSV/MySQL 持久化共享这些模型。
- **持久化层**：`src/clinic/persistence/` 内各 `*Repository` 借助 `CsvDataStore` 读写 CSV，结合 `src/clinic/persistence/mysql/CsvToMySqlMirror.java` 可实现 CSV→MySQL 双写。
- **服务层**：`src/clinic/service/` 封装业务规则、校验与跨实体编排，例如预约状态流转、库存计算、审计记录等。
- **界面层**：`src/clinic/ui/` 下按照角色划分子目录；所有面板实现 `Refreshable` 以支持定时刷新与统一的 UI 工具集。
- **辅助工具**：`src/clinic/tools/` 提供批量数据导入、校验与存储巡检；`src/clinic/util/DoctorMatcher.java` 实现医生姓名模糊匹配，服务欢迎页与预约模块。

## 1. 账号与权限体系

- **功能描述**：支持医生、管理员、患者三类角色登录；提供患者自助注册入口；登录成功后按角色加载不同工作台。
- **UI 入口**：`src/clinic/ui/LoginFrame.java`、`src/clinic/ui/RegisterDialog.java`。
- **核心服务**：`src/clinic/service/AuthService.java`（密码校验、角色识别）。
- **数据持久化**：`src/clinic/persistence/UserRepository.java`，数据文件 `data/users.csv`。
- **身份校验**：医生与患者登录均依赖用户名+密码（SHA-256 哈希），医生在跨面板操作时还会通过 `src/clinic/security/PermissionGuard.java` 校验所操作资源的医生编号；管理员账号仅需成功登录即可执行全局操作，无需额外的医生身份匹配。

## 2. 患者门户

| 功能 | 关键操作 | UI 面板 | 业务服务 | 数据来源 |
| ---- | -------- | ------- | -------- | -------- |
| 预约查询与状态跟踪 | 列表筛选、患者自助创建/取消、医生名称自动映射 | `src/clinic/ui/patient/PatientAppointmentPanel.java` | `src/clinic/service/AppointmentService.java`、`src/clinic/service/DoctorService.java` | `data/appointments.csv`、`data/doctors.csv` |
| 科室智能挂号与医生筛选 | 科室筛选、评分排序、快速发起预约请求 | `src/clinic/ui/patient/PatientDepartmentBookingPanel.java` | `src/clinic/service/DoctorService.java`、`src/clinic/service/AppointmentService.java` | `data/doctors.csv`、`data/appointments.csv` |
| 问诊记录与处方查看 | 展示历史问诊、按医生搜索、时间排序 | `src/clinic/ui/patient/ConsultationHistoryPanel.java` | `src/clinic/service/ConsultationService.java`、`src/clinic/service/DoctorService.java` | `data/consultations.csv`、`data/doctors.csv` |
| 个人病例知识库 | 个人病例汇总、标签检索、附件路径展示 | `src/clinic/ui/patient/PatientCaseRecordPanel.java` | `src/clinic/service/CaseRecordService.java` | `data/case_library.csv` |
| 专家建议与随访提醒 | 查看专家建议、刷新提醒、支持关键词过滤 | `src/clinic/ui/patient/PatientExpertAdvicePanel.java` | `src/clinic/service/ExpertAdviceService.java` | `data/expert_advices.csv` |
| 工作进度跟踪 | 展示诊疗任务、状态分组、更新时间提示 | `src/clinic/ui/patient/PatientWorkProgressPanel.java` | `src/clinic/service/WorkProgressService.java` | `data/work_progress.csv` |
| 日程与排班视图 | 组合展示预约与随访事件、时间轴排序 | `src/clinic/ui/patient/PatientSchedulePanel.java` | `src/clinic/service/CalendarEventService.java`、`src/clinic/service/AppointmentService.java` | `data/calendar_events.csv`、`data/appointments.csv` |
| 药房库存状态 | 药品列表、库存数量、低库存提醒说明 | `src/clinic/ui/patient/PharmacyStatusPanel.java` | `src/clinic/service/PharmacyService.java` | `data/medicines.csv` |

- **跨模块联动**：患者端欢迎页 `src/clinic/ui/WelcomePanel.java` 会聚合预约、CalendarEvent、专家建议与工作进度，触发上述面板的 `refreshData()`。
- **服务依赖**：患者功能依托 `AppointmentService`、`DoctorService`、`ConsultationService`、`CaseRecordService` 等服务获取资料，所有读写走 AppContext 注册的仓库。
- **权限边界**：患者仅能访问自身数据，依靠服务层根据 `userId` 过滤（例如 `AppointmentService#listAppointments()` 在 UI 层按患者 ID 二次筛选）。

## 3. 医生门户

| 功能 | 关键操作 | UI 面板 | 业务服务 | 关联数据 |
| ---- | -------- | ------- | -------- | -------- |
| 患者管理与备注 | 搜索、增删改患者档案、校验生日格式 | `src/clinic/ui/doctor/PatientManagementPanel.java` | `src/clinic/service/PatientService.java` | `data/patients.csv` |
| 预约审批与排班 | 新增预约、更新状态、权限校验、删除预约 | `src/clinic/ui/doctor/AppointmentManagementPanel.java` | `src/clinic/service/AppointmentService.java`、`src/clinic/service/CalendarEventService.java`、`src/clinic/service/DoctorService.java` | `data/appointments.csv`、`data/calendar_events.csv`、`data/doctors.csv` |
| 问诊录入与处方维护 | 新增问诊、编辑摘要、创建处方、删除记录 | `src/clinic/ui/doctor/ConsultationManagementPanel.java` | `src/clinic/service/ConsultationService.java`、`src/clinic/service/PharmacyService.java`、`src/clinic/service/AppointmentService.java` | `data/consultations.csv`、`data/prescriptions.csv`、`data/appointments.csv` |
| 药房日常管理 | 药品目录维护、库存同步、成本信息录入 | `src/clinic/ui/doctor/MedicineManagementPanel.java` | `src/clinic/service/PharmacyService.java`、`src/clinic/service/InventoryService.java` | `data/medicines.csv`、`data/stock_movements.csv` |
| 专家建议下发 | 创建/编辑专家建议、关联患者与随访计划 | `src/clinic/ui/doctor/ExpertAdvicePanel.java` | `src/clinic/service/ExpertAdviceService.java`、`src/clinic/service/PatientService.java` | `data/expert_advices.csv`、`data/patients.csv` |
| 财务中心（收费、退款、理赔） | 录入收费、更新状态、退款、理赔审批、审计记录 | `src/clinic/ui/doctor/FinanceCenterPanel.java` | `src/clinic/service/PaymentService.java`、`src/clinic/service/InsuranceClaimService.java`、`src/clinic/service/AuditService.java` | `data/payments.csv`、`data/insurance_claims.csv`、`data/audit_logs.csv` |
| 库存流水（入库/出库/盘点） | 入库、出库、盘点调整、库存金额计算、自动审计 | `src/clinic/ui/doctor/InventoryManagementPanel.java` | `src/clinic/service/InventoryService.java`、`src/clinic/service/PharmacyService.java`、`src/clinic/service/AuditService.java` | `data/stock_movements.csv`、`data/medicines.csv`、`data/audit_logs.csv` |
| 专家会诊排期与参与者 | 会诊排班、参会人员维护、会议提醒 | `src/clinic/ui/doctor/ExpertSessionManagementPanel.java` | `src/clinic/service/ExpertSessionService.java`、`src/clinic/service/ExpertAdviceService.java` | `data/expert_sessions.csv`、`data/expert_participants.csv`、`data/expert_advices.csv` |
| 会诊纪要与行动项 | 录入纪要、跟踪行动项、时间戳展示 | `src/clinic/ui/doctor/MeetingMinutesPanel.java` | `src/clinic/service/MeetingMinuteService.java`、`src/clinic/service/PatientService.java` | `data/meeting_minutes.csv`、`data/patients.csv` |
| 案例知识库 | 案例检索、按标签筛选、详情弹窗 | `src/clinic/ui/doctor/CaseLibraryPanel.java` | `src/clinic/service/CaseRecordService.java` | `data/case_library.csv` |
| 工作进度看板 | 任务分配、状态更新、提醒患者 | `src/clinic/ui/doctor/WorkProgressPanel.java` | `src/clinic/service/WorkProgressService.java` | `data/work_progress.csv` |
| 工作日程 | 创建/编辑日程、同步预约、自定义说明 | `src/clinic/ui/doctor/CalendarManagementPanel.java` | `src/clinic/service/CalendarEventService.java`、`src/clinic/service/AppointmentService.java` | `data/calendar_events.csv`、`data/appointments.csv` |
| 智能洞察助手 | 汇总患者洞察、跨模块数据聚合、刷新策略 | `src/clinic/ui/doctor/InsightAssistantPanel.java` | `src/clinic/service/InsightService.java`、`src/clinic/service/WorkProgressService.java`、`src/clinic/service/ExpertAdviceService.java` | 多数据源聚合 |

- **权限控制**：医生侧面板通过 `src/clinic/security/PermissionGuard.java` 验证操作范围（如预约、问诊、建议的责任医生）。
- **刷新与监听**：大部分面板在构造函数内注册搜索过滤器与刷新按钮，并在 `MainFrame` 的定时任务中调用 `refreshData()`。
- **关联逻辑**：处方创建会调用 `PharmacyService#createPrescription`，库存流水使用 `InventoryService#recordInbound/Outbound/Adjustment` 并调用 `AuditService#logAction` 形成审计链路。

## 4. 管理员门户

- **审计日志检索**：`src/clinic/ui/administrator/AuditLogPanel.java` 按时间倒序展示日志，支持模糊检索、手动刷新；日志字段包括用户、角色、动作、实体、结果与时间戳，数据由 `src/clinic/service/AuditService.java` 读取 `data/audit_logs.csv`。
- **运营监督**：管理员登录后自动加载医生门户的“财务中心”“库存流水”标签，用于财务对账与库存盘点，配合审计日志追踪关键操作。
- **风险提示**：面板页脚提供审计说明，提示系统会记录支付、库存调整、理赔等关键事件，为合规与风控提供可追溯依据。

## 5. 财务、理赔与库存

- **收费与账单**：`src/clinic/service/PaymentService.java` 支持 `PENDING/PROCESSING/PAID/FAILED/REFUNDED` 多状态流转、收入统计与理赔关联；仓库 `src/clinic/persistence/PaymentRepository.java` 对应数据 `data/payments.csv`。
- **医保理赔流程**：`src/clinic/service/InsuranceClaimService.java` 处理提交通知、`APPROVED/REJECTED/PAID` 状态更新与赔付金额校验；仓库 `InsuranceClaimRepository.java` 读写 `data/insurance_claims.csv`。
- **库存流水**：`src/clinic/service/InventoryService.java` 记录入库/出库/盘点调整，并提供存量与金额计算；依赖 `StockMovementRepository.java` 和 `data/stock_movements.csv`。
- **操作审计**：`src/clinic/service/AuditService.java` 统一写入支付、库存、理赔等关键动作；数据存储 `data/audit_logs.csv`，由 `AuditLogRepository.java` 维护。
- **财务仪表盘**：`FinanceCenterPanel` 聚合上述服务，自动调用 `AuditService#logAction` 保留操作流水，并通过 `InventoryService` 把退款、理赔与库存联动展示。

## 6. 专家会诊与会议纪要链路

- **排期与邀请**：`src/clinic/service/ExpertSessionService.java` 与 `src/clinic/ui/doctor/ExpertSessionManagementPanel.java` 负责会诊排班、参会医生/专家选择及提醒信息；数据 `data/expert_sessions.csv`。
- **参会人员管理**：`src/clinic/persistence/ExpertParticipantRepository.java` 与服务端联动维护参会者、角色与联系方式；数据 `data/expert_participants.csv`。
- **会议纪要与行动项**：`src/clinic/service/MeetingMinuteService.java` + `src/clinic/ui/doctor/MeetingMinutesPanel.java` 提供纪要录入、行动项跟踪和最新更新时间展示；数据 `data/meeting_minutes.csv`。
- **专家随访建议**：`src/clinic/service/ExpertAdviceService.java` + `ExpertAdvicePanel`、`PatientExpertAdvicePanel` 打通会诊结果到患者随访；数据 `data/expert_advices.csv`。

## 7. 智能洞察（Insight）

- **服务聚合**：`src/clinic/service/InsightService.java` 同步读取问诊、病例、工作进度、专家建议等多源数据，提供待办提醒、风险提示与患者洞察摘要。
- **UI 呈现**：医生端 `src/clinic/ui/doctor/InsightAssistantPanel.java`、患者端 `PatientWorkProgressPanel` 等实现 `Refreshable` 接口并通过 `MainFrame` 定时任务刷新，保证洞察实时性。
- **算法辅助**：`src/clinic/util/DoctorMatcher.java` 对医生姓名做归一化匹配，欢迎页 `WelcomePanel` 与洞察模块借此消除姓名差异导致的关联问题。

## 8. 数据持久化与同步

- **CSV 通用读写**：`src/clinic/persistence/CsvDataStore.java` 提供泛型读写、ID 生成与文件锁控制。
- **MySQL 持续双写**：`src/clinic/persistence/mysql/CsvToMySqlMirror.java` 配合 `MySqlConnectionManager` 在写 CSV 同时更新 MySQL；支持环境变量 `CLINIC_DB_URL`、`CLINIC_DB_USERNAME`、`CLINIC_DB_PASSWORD`，以及开关 `CLINIC_DB_SYNC_ENABLED`。
- **主数据仓库**：各 `*Repository` 位于 `src/clinic/persistence/` 目录，对应 `data/` 下 CSV 文件。

## 9. UI 框架与刷新机制

- **主框架**：`src/clinic/ui/MainFrame.java` 负责角色识别、标签注册、全局刷新定时器（默认 15 秒）。
- **刷新接口**：`src/clinic/ui/Refreshable.java`，配合 `TableUtils`、`UIUtils` 提供统一交互体验。
- **安全控制**：`src/clinic/security/PermissionGuard.java` 在医生端面板中执行权限校验。
- **欢迎页入口**：`src/clinic/ui/WelcomePanel.java` 聚合待办、日程摘要，在登录后作为默认页展示。

## 10. 数据与脚本

- **示例数据**：`data/`（运行环境）与 `release/clinic-app-v1.1.0/data/`（发布包）存储业务样例。
- **MySQL 迁移脚本**：`scripts/mysql/create_schema.sql`、`scripts/mysql/import_csv.sh`。
- **打包脚本**：`scripts/package_release.sh` 生成 `release/clinic-app-v1.1.0.zip`。
- **运维工具**：`src/clinic/tools/` 下的 `DataSeeder`、`BulkDataSeeder`、`StorageVerificationTool` 提供批量导入与数据完整性校验。

## 11. 文档与发布物

- **用户与设计文档**：`docs/README.md`、`docs/系统设计说明.md`、本文件 `docs/系统功能总览.md`。
- **Release 资料**：`release/clinic-app-v1.1.0/README.md`、`release/clinic-app-v1.1.0/系统设计说明.md`，以及跨平台启动脚本 `RUN.sh`、`RUN.bat`。

通过以上映射，可快速定位任一功能在 UI、服务、仓库和数据层的实现位置，支撑后续开发、测试与对外交付。
